const langDict = {
    'ç¹é«”ä¸­æ–‡': {
        'pageTitle': 'RTV è©³ç´°ä¿¡æ¯',
        'btnBack': 'è¿”å›žä¸»é ',
        'sectionBasic': 'åŸºæœ¬ä¿¡æ¯',
        'sectionTimeline': 'RTV æµç¨‹è¿½è¹¤',
        'progressText': 'é€²åº¦',
        'labelQPN': 'æ–™è™Ÿ QPN',
        'labelSN': 'SN',
        'labelDept': 'éƒ¨é–€',
        'labelRequester': 'ç”³è«‹äººå“¡',
        'labelResult': 'æ¸¬è©¦çµæžœ',
        'labelTime': 'å»ºç«‹æ™‚é–“',
        'stage1Title': 'ç°½æ ¸ä¸­',
        'stage1Desc': 'RTV ç”³è«‹æ–‡ä»¶ç°½æ ¸å¯©æ‰¹ä¸­',
        'stage2Title': 'æ”¾è¡Œä¸­',
        'stage2Desc': 'ç°½æ ¸å®Œæˆï¼Œæº–å‚™æ”¾è¡Œç‰©æ–™',
        'stage3Title': 'å·²äº¤çµ¦FAE',
        'stage3Desc': 'ç‰©æ–™å·²ç§»äº¤çµ¦ FAE è™•ç†',
        'stage4Title': 'å¿«éžå–®è™Ÿç”Ÿæˆä¸­',
        'stage4Desc': 'ç³»çµ±æ­£åœ¨ç”Ÿæˆå¿«éžè¿½è¹¤å–®è™Ÿ',
        'stage5Title': 'å¿«éžå–®è™Ÿ',
        'stage5Desc': 'è«‹è¼¸å…¥å¿«éžè¿½è¹¤å–®è™Ÿ',
        'stage6Title': 'å·²æŠµé”å» å•†ç«¯',
        'stage6Desc': 'ç‰©æ–™å·²é€é”å» å•†',
        'stage7Title': 'FAé€²è¡Œä¸­',
        'stage7Desc': 'å» å•†æ­£åœ¨é€²è¡Œå¤±æ•ˆåˆ†æž',
        'stage8Title': 'FAçµæžœå·²æäº¤',
        'stage8Desc': 'æœ€çµ‚ FA åˆ†æžå ±å‘Šå·²å®Œæˆ',
        'labelTracking': 'å¿«éžå–®è™Ÿ',
        'labelFAStatus': 'FA ç‹€æ…‹/å–®è™Ÿ',
        'labelFAResult': 'FA çµæžœ',
        'trackingDisplay': 'å¿«éžå–®è™Ÿ',
        'btnComplete': 'å®Œæˆæ­¤éšŽæ®µ',
        'btnComplete5': 'ç¢ºèªå–®è™Ÿä¸¦ç¹¼çºŒ',
        'btnComplete8': 'å®Œæˆæ•´å€‹æµç¨‹',
        'btnReset': 'é‡ç½®æµç¨‹',
        'btnCancel': 'å–æ¶ˆ',
        'btnSave': 'ä¿å­˜æ›´æ”¹',
        'btnPrint': 'åˆ—å°å ±å‘Š',
        'statusReady': 'æº–å‚™å°±ç·’ã€‚',
        'statusSaved': 'âœ… æ›´æ”¹å·²ä¿å­˜ï¼',
        'statusCompleted': 'ðŸŽ‰ æµç¨‹å·²å®Œæˆï¼',
        'statusPending': 'å¾…è™•ç†',
        'statusInProgress': 'é€²è¡Œä¸­',
        'statusDone': 'å·²å®Œæˆ',
        'recordNotFound': 'âŒ æ‰¾ä¸åˆ°è¨˜éŒ„ï¼',
        'pleaseEnterTracking': 'âš ï¸ è«‹è¼¸å…¥å¿«éžå–®è™Ÿï¼',
        'pleaseEnterFAResult': 'âš ï¸ è«‹è¼¸å…¥ FA çµæžœï¼',
        'confirmReset': 'ç¢ºå®šè¦é‡ç½®æ•´å€‹æµç¨‹å—Žï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ã€‚',
        'language': 'èªžè¨€'
    },
    'English': {
        'pageTitle': 'RTV Details',
        'btnBack': 'Back to Main',
        'sectionBasic': 'Basic Information',
        'sectionTimeline': 'RTV Process Tracking',
        'progressText': 'Progress',
        'labelQPN': 'QPN',
        'labelSN': 'SN',
        'labelDept': 'Department',
        'labelRequester': 'Requester',
        'labelResult': 'Test Result',
        'labelTime': 'Created Time',
        'stage1Title': 'Approval in Progress',
        'stage1Desc': 'RTV application under approval',
        'stage2Title': 'Release in Progress',
        'stage2Desc': 'Approval completed, preparing release',
        'stage3Title': 'Handed over to FAE',
        'stage3Desc': 'Material handed over to FAE',
        'stage4Title': 'Generating Tracking Number',
        'stage4Desc': 'System generating tracking number',
        'stage5Title': 'Tracking Number',
        'stage5Desc': 'Please enter tracking number',
        'stage6Title': 'Arrived at Vendor',
        'stage6Desc': 'Material arrived at vendor',
        'stage7Title': 'FA in Progress',
        'stage7Desc': 'Vendor conducting failure analysis',
        'stage8Title': 'FA Result Submitted',
        'stage8Desc': 'Final FA report completed',
        'labelTracking': 'Tracking Number',
        'labelFAStatus': 'FA Status/Tracking#',
        'labelFAResult': 'FA Result',
        'trackingDisplay': 'Tracking Number',
        'btnComplete': 'Complete This Stage',
        'btnComplete5': 'Confirm & Continue',
        'btnComplete8': 'Complete Process',
        'btnReset': 'Reset Process',
        'btnCancel': 'Cancel',
        'btnSave': 'Save Changes',
        'btnPrint': 'Print Report',
        'statusReady': 'Ready.',
        'statusSaved': 'âœ… Changes saved!',
        'statusCompleted': 'ðŸŽ‰ Process completed!',
        'statusPending': 'Pending',
        'statusInProgress': 'In Progress',
        'statusDone': 'Completed',
        'recordNotFound': 'âŒ Record not found!',
        'pleaseEnterTracking': 'âš ï¸ Please enter tracking number!',
        'pleaseEnterFAResult': 'âš ï¸ Please enter FA result!',
        'confirmReset': 'Reset the entire process? This will clear all progress.',
        'language': 'Language'
    },
    'Tiáº¿ng Viá»‡t': {
        'pageTitle': 'Chi tiáº¿t RTV',
        'btnBack': 'Quay láº¡i',
        'sectionBasic': 'ThÃ´ng tin cÆ¡ báº£n',
        'sectionTimeline': 'Theo dÃµi quy trÃ¬nh',
        'progressText': 'Tiáº¿n Ä‘á»™',
        'labelQPN': 'QPN',
        'labelSN': 'SN',
        'labelDept': 'Bá»™ pháº­n',
        'labelRequester': 'NgÆ°á»i yÃªu cáº§u',
        'labelResult': 'Káº¿t quáº£',
        'labelTime': 'Thá»i gian táº¡o',
        'stage1Title': 'Äang phÃª duyá»‡t',
        'stage1Desc': 'ÄÆ¡n RTV Ä‘ang Ä‘Æ°á»£c phÃª duyá»‡t',
        'stage2Title': 'Äang phÃ¡t hÃ nh',
        'stage2Desc': 'PhÃª duyá»‡t hoÃ n táº¥t',
        'stage3Title': 'ÄÃ£ giao cho FAE',
        'stage3Desc': 'Váº­t liá»‡u Ä‘Ã£ chuyá»ƒn giao',
        'stage4Title': 'Äang táº¡o sá»‘ theo dÃµi',
        'stage4Desc': 'Há»‡ thá»‘ng Ä‘ang táº¡o sá»‘',
        'stage5Title': 'Sá»‘ theo dÃµi',
        'stage5Desc': 'Nháº­p sá»‘ theo dÃµi',
        'stage6Title': 'ÄÃ£ Ä‘áº¿n nhÃ  cung cáº¥p',
        'stage6Desc': 'Váº­t liá»‡u Ä‘Ã£ Ä‘áº¿n',
        'stage7Title': 'FA Ä‘ang tiáº¿n hÃ nh',
        'stage7Desc': 'Äang phÃ¢n tÃ­ch lá»—i',
        'stage8Title': 'Káº¿t quáº£ FA Ä‘Ã£ gá»­i',
        'stage8Desc': 'BÃ¡o cÃ¡o hoÃ n thÃ nh',
        'labelTracking': 'Sá»‘ theo dÃµi',
        'labelFAStatus': 'Tráº¡ng thÃ¡i FA',
        'labelFAResult': 'Káº¿t quáº£ FA',
        'trackingDisplay': 'Sá»‘ theo dÃµi',
        'btnComplete': 'HoÃ n thÃ nh giai Ä‘oáº¡n',
        'btnComplete5': 'XÃ¡c nháº­n & Tiáº¿p tá»¥c',
        'btnComplete8': 'HoÃ n thÃ nh quy trÃ¬nh',
        'btnReset': 'Äáº·t láº¡i',
        'btnCancel': 'Há»§y',
        'btnSave': 'LÆ°u thay Ä‘á»•i',
        'btnPrint': 'In bÃ¡o cÃ¡o',
        'statusReady': 'Sáºµn sÃ ng.',
        'statusSaved': 'âœ… ÄÃ£ lÆ°u!',
        'statusCompleted': 'ðŸŽ‰ HoÃ n thÃ nh!',
        'statusPending': 'Äang chá»',
        'statusInProgress': 'Äang tiáº¿n hÃ nh',
        'statusDone': 'HoÃ n thÃ nh',
        'recordNotFound': 'âŒ KhÃ´ng tÃ¬m tháº¥y!',
        'pleaseEnterTracking': 'âš ï¸ Nháº­p sá»‘ theo dÃµi!',
        'pleaseEnterFAResult': 'âš ï¸ Nháº­p káº¿t quáº£ FA!',
        'confirmReset': 'Äáº·t láº¡i toÃ n bá»™ quy trÃ¬nh?',
        'language': 'NgÃ´n ngá»¯'
    }
};

let currentLang = 'ç¹é«”ä¸­æ–‡';
let currentRecord = null;
let recordId = null;
let currentStage = 0;

const getEl = (id) => document.getElementById(id);

document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    recordId = urlParams.get('id');
    if (!recordId) {
        alert('éŒ¯èª¤ï¼šæœªæŒ‡å®šè¨˜éŒ„ IDï¼');
        window.location.href = 'index.html';
        return;
    }
    loadRecord();
    setupEventListeners();
    applyLanguage();
    lucide.createIcons();
});

function loadRecord() {
    const storedRecords = localStorage.getItem('iqcRecords');
    if (!storedRecords) {
        updateStatus(langDict[currentLang].recordNotFound);
        setTimeout(() => window.location.href = 'index.html', 2000);
        return;
    }
    const records = JSON.parse(storedRecords);
    currentRecord = records.find(r => r.id === parseInt(recordId));
    if (!currentRecord) {
        updateStatus(langDict[currentLang].recordNotFound);
        setTimeout(() => window.location.href = 'index.html', 2000);
        return;
    }
    if (!currentRecord.rtv_data) {
        currentRecord.rtv_data = {
            current_stage: 0,
            tracking_number: '',
            fa_status: '',
            fa_result: '',
            stage_completion: {
                stage1: false, stage2: false, stage3: false, stage4: false,
                stage5: false, stage6: false, stage7: false, stage8: false
            },
            completion_dates: {}
        };
    }
    currentStage = currentRecord.rtv_data.current_stage || 0;
    displayRecordInfo();
    loadRTVData();
    updateAllStages();
}

function displayRecordInfo() {
    getEl('display-qpn').textContent = currentRecord.qpn || '-';
    getEl('display-sn').textContent = currentRecord.sn || '-';
    getEl('display-dept').textContent = currentRecord.dept || '-';
    getEl('display-requester').textContent = currentRecord.requester || '-';
    getEl('display-result').textContent = currentRecord.result || '-';
    getEl('display-time').textContent = currentRecord.timestamp || '-';
}

function loadRTVData() {
    const data = currentRecord.rtv_data || {};
    if (data.tracking_number) {
        getEl('tracking-number').value = data.tracking_number;
        getEl('tracking-value').textContent = data.tracking_number;
    }
    getEl('fa-status').value = data.fa_status || '';
    getEl('fa-result').value = data.fa_result || '';
}

function saveRTVData() {
    const data = currentRecord.rtv_data;
    data.tracking_number = getEl('tracking-number').value;
    data.fa_status = getEl('fa-status').value;
    data.fa_result = getEl('fa-result').value;
    const storedRecords = localStorage.getItem('iqcRecords');
    const records = JSON.parse(storedRecords);
    const index = records.findIndex(r => r.id === parseInt(recordId));
    if (index > -1) {
        records[index] = currentRecord;
        localStorage.setItem('iqcRecords', JSON.stringify(records));
        updateStatus(langDict[currentLang].statusSaved);
    }
}

function completeStage(stage) {
    const lang = langDict[currentLang];
    if (stage === 5) {
        const trackingNumber = getEl('tracking-number').value.trim();
        if (!trackingNumber) {
            alert(lang.pleaseEnterTracking);
            getEl('tracking-number').focus();
            return;
        }
        getEl('tracking-value').textContent = trackingNumber;
    }
    if (stage === 8) {
        const faResult = getEl('fa-result').value.trim();
        if (!faResult) {
            alert(lang.pleaseEnterFAResult);
            getEl('fa-result').focus();
            return;
        }
    }
    currentRecord.rtv_data.stage_completion['stage' + stage] = true;
    currentRecord.rtv_data.completion_dates['stage' + stage] = new Date().toISOString();
    currentRecord.rtv_data.current_stage = stage;
    currentStage = stage;
    saveRTVData();
    updateAllStages();
    if (stage === 8) {
        updateStatus(lang.statusCompleted);
        confetti();
    }
}

function resetProcess() {
    const lang = langDict[currentLang];
    if (!confirm(lang.confirmReset)) return;
    currentRecord.rtv_data = {
        current_stage: 0,
        tracking_number: '',
        fa_status: '',
        fa_result: '',
        stage_completion: {
            stage1: false, stage2: false, stage3: false, stage4: false,
            stage5: false, stage6: false, stage7: false, stage8: false
        },
        completion_dates: {}
    };
    currentStage = 0;
    getEl('tracking-number').value = '';
    getEl('fa-status').value = '';
    getEl('fa-result').value = '';
    saveRTVData();
    updateAllStages();
    updateStatus(lang.statusReady);
}

function updateAllStages() {
    const completion = currentRecord.rtv_data.stage_completion;
    const lang = langDict[currentLang];
    const completedCount = Object.values(completion).filter(v => v).length;
    const progressPercentage = Math.round((completedCount / 8) * 100);
    getEl('progress-percentage').textContent = progressPercentage + '%';
    const progressBar = getEl('progress-bar');
    const totalHeight = document.querySelector('.timeline').offsetHeight;
    progressBar.style.height = (completedCount / 8) * totalHeight + 'px';
    for (let i = 1; i <= 8; i++) {
        const stageEl = getEl('stage-' + i);
        const badgeEl = getEl('stage-' + i + '-badge');
        stageEl.classList.remove('pending', 'active', 'completed');
        if (completion['stage' + i]) {
            stageEl.classList.add('completed');
            badgeEl.textContent = lang.statusDone;
            badgeEl.className = 'px-3 py-1 text-xs font-semibold rounded-full bg-blue-200 text-blue-700';
        } else if (currentStage === i - 1) {
            stageEl.classList.add('active');
            badgeEl.textContent = lang.statusInProgress;
            badgeEl.className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-200 text-green-700';
        } else {
            stageEl.classList.add('pending');
            badgeEl.textContent = lang.statusPending;
            badgeEl.className = 'px-3 py-1 text-xs font-semibold rounded-full bg-gray-200 text-gray-700';
        }
    }
}

function setupEventListeners() {
    getEl('lang-selector').addEventListener('change', (e) => {
        currentLang = e.target.value;
        applyLanguage();
    });
    getEl('save-btn').addEventListener('click', saveRTVData);
    getEl('reset-btn').addEventListener('click', resetProcess);
    getEl('print-btn').addEventListener('click', () => window.print());
    const fields = ['tracking-number', 'fa-status', 'fa-result'];
    fields.forEach(fieldId => {
        const el = getEl(fieldId);
        if (el) el.addEventListener('blur', () => saveRTVData());
    });
}

function applyLanguage() {
    const lang = langDict[currentLang];
    getEl('page-title').textContent = lang.pageTitle;
    getEl('btn-back').textContent = lang.btnBack;
    getEl('section-basic').textContent = lang.sectionBasic;
    getEl('section-timeline').textContent = lang.sectionTimeline;
    getEl('progress-text').innerHTML = lang.progressText + 'ï¼š<span id="progress-percentage" class="font-bold text-indigo-600">' + getEl('progress-percentage').textContent + '</span>';
    getEl('label-qpn-display').innerHTML = '<i data-lucide="package" class="w-3 h-3 mr-1"></i>' + lang.labelQPN;
    getEl('label-sn-display').innerHTML = '<i data-lucide="hash" class="w-3 h-3 mr-1"></i>' + lang.labelSN;
    getEl('label-dept-display').innerHTML = '<i data-lucide="building" class="w-3 h-3 mr-1"></i>' + lang.labelDept;
    getEl('label-requester-display').innerHTML = '<i data-lucide="user" class="w-3 h-3 mr-1"></i>' + lang.labelRequester;
    getEl('label-result-display').innerHTML = '<i data-lucide="check-circle" class="w-3 h-3 mr-1"></i>' + lang.labelResult;
    getEl('label-time-display').innerHTML = '<i data-lucide="calendar" class="w-3 h-3 mr-1"></i>' + lang.labelTime;
    for (let i = 1; i <= 8; i++) {
        getEl('stage-' + i + '-title').textContent = lang['stage' + i + 'Title'];
        getEl('stage-' + i + '-desc').textContent = lang['stage' + i + 'Desc'];
    }
    getEl('label-tracking').textContent = lang.labelTracking;
    getEl('label-fa-status').textContent = lang.labelFAStatus;
    getEl('label-fa-result').textContent = lang.labelFAResult;
    getEl('tracking-display').innerHTML = '<i data-lucide="info" class="w-4 h-4 mr-2"></i>' + lang.trackingDisplay + 'ï¼š<span class="font-mono font-semibold" id="tracking-value">' + getEl('tracking-value').textContent + '</span>';
    for (let i = 1; i <= 4; i++) getEl('btn-complete-' + i).textContent = lang.btnComplete;
    getEl('btn-complete-5').textContent = lang.btnComplete5;
    for (let i = 6; i <= 7; i++) getEl('btn-complete-' + i).textContent = lang.btnComplete;
    getEl('btn-complete-8').textContent = lang.btnComplete8;
    getEl('btn-reset').textContent = lang.btnReset;
    getEl('btn-cancel').textContent = lang.btnCancel;
    getEl('btn-save').textContent = lang.btnSave;
    getEl('btn-print').textContent = lang.btnPrint;
    updateAllStages();
    lucide.createIcons();
}

function updateStatus(message, clearAfterMs = 3000) {
    const statusBar = getEl('status-bar');
    statusBar.textContent = message;
    if (window.statusTimeout) clearTimeout(window.statusTimeout);
    if (clearAfterMs > 0) {
        window.statusTimeout = setTimeout(() => {
            statusBar.textContent = langDict[currentLang].statusReady;
        }, clearAfterMs);
    }
}

function confetti() {
    const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe'];
    const confettiCount = 50;
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'fixed';
        confetti.style.width = '10px';
        confetti.style.height = '10px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * window.innerWidth + 'px';
        confetti.style.top = '-10px';
        confetti.style.opacity = '1';
        confetti.style.borderRadius = '50%';
        confetti.style.zIndex = '9999';
        confetti.style.pointerEvents = 'none';
        document.body.appendChild(confetti);
        const fallDuration = 2000 + Math.random() * 1000;
        const horizontalMovement = (Math.random() - 0.5) * 200;
        confetti.animate([
            { transform: 'translate(0, 0) rotate(0deg)', opacity: 1 },
            { transform: 'translate(' + horizontalMovement + 'px, ' + (window.innerHeight + 10) + 'px) rotate(' + (Math.random() * 720) + 'deg)', opacity: 0 }
        ], {
            duration: fallDuration,
            easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
        }).onfinish = () => confetti.remove();
    }
}

window.completeStage = completeStage;
window.resetProcess = resetProcess;
