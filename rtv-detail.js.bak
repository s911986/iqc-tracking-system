const langDict = {
    'ÁπÅÈ´î‰∏≠Êñá': {
        'pageTitle': 'RTV Ë©≥Á¥∞‰ø°ÊÅØ',
        'btnBack': 'ËøîÂõû‰∏ªÈ†Å',
        'sectionBasic': 'Âü∫Êú¨‰ø°ÊÅØ',
        'sectionTimeline': 'RTV ÊµÅÁ®ãËøΩËπ§',
        'progressText': 'ÈÄ≤Â∫¶',
        'labelQPN': 'ÊñôËôü QPN',
        'labelSN': 'SN',
        'labelDept': 'ÈÉ®ÈñÄ',
        'stage1Title': 'Kick Off',
        'stage1Desc': 'RTV ÊµÅÁ®ãÂïüÂãï',
        'stage2Title': 'Â∑≤Èõ¢Âª†',
        'stage2Desc': 'Áâ©ÊñôÂ∑≤Èõ¢ÈñãÂ∑•Âª†',
        'stage3Title': 'ÈÅ∏ÊìáÈÅãÈÄÅÊñπÂºè',
        'stage3Desc': 'Ë´ãÈÅ∏ÊìáÂø´ÈÅûÊàñÈÄÄÈÅã',
        'stage4aTitle': 'Ëº∏ÂÖ•Âø´ÈÅûÂñÆËôü',
        'stage4aDesc': 'Ë´ãËº∏ÂÖ•Âø´ÈÅûËøΩËπ§ÂñÆËôü',
        'stage5aTitle': 'Â∑≤ÊäµÈÅîÂª†ÂïÜÁ´Ø',
        'stage5aDesc': 'Áâ©ÊñôÂ∑≤ÈÄÅÈÅîÂª†ÂïÜ (Âø´ÈÅû)',
        'stage4bTitle': 'Â∑≤ÊäµÈÅîÂª†ÂïÜÁ´Ø',
        'stage4bDesc': 'Áâ©ÊñôÂ∑≤ÈÄÅÈÅîÂª†ÂïÜ (ÈÄÄÈÅã)',
        'stage6Title': 'FAÈÄ≤Ë°å‰∏≠',
        'stage6Desc': 'Âª†ÂïÜÊ≠£Âú®ÈÄ≤Ë°åÂ§±ÊïàÂàÜÊûê',
        'stage7Title': 'FAÂ∑≤ÂÆåÊàê',
        'stage7Desc': 'Â§±ÊïàÂàÜÊûêÂ†±ÂëäÂ∑≤ÂÆåÊàê',
        'labelTracking': 'Âø´ÈÅûÂñÆËôü',
        'trackingDisplay': 'Âø´ÈÅûÂñÆËôü',
        'routeExpressLabel': 'Âø´ÈÅû',
        'routeReturnLabel': 'ÈÄÄÈÅã',
        'btnComplete': 'ÂÆåÊàêÊ≠§ÈöéÊÆµ',
        'btnComplete4a': 'Á¢∫Ë™çÂñÆËôü‰∏¶ÁπºÁ∫å',
        'btnComplete7': 'ÂÆåÊàêÊï¥ÂÄãÊµÅÁ®ã',
        'btnReset': 'ÈáçÁΩÆÊµÅÁ®ã',
        'btnCancel': 'ÂèñÊ∂à',
        'btnSave': '‰øùÂ≠òÊõ¥Êîπ',
        'btnPrint': 'ÂàóÂç∞Â†±Âëä',
        'statusReady': 'Ê∫ñÂÇôÂ∞±Á∑í„ÄÇ',
        'statusSaved': '‚úÖ Êõ¥ÊîπÂ∑≤‰øùÂ≠òÔºÅ',
        'statusCompleted': 'üéâ ÊµÅÁ®ãÂ∑≤ÂÆåÊàêÔºÅ',
        'statusPending': 'ÂæÖËôïÁêÜ',
        'statusInProgress': 'ÈÄ≤Ë°å‰∏≠',
        'statusDone': 'Â∑≤ÂÆåÊàê',
        'recordNotFound': '‚ùå Êâæ‰∏çÂà∞Ë®òÈåÑÔºÅ',
        'pleaseEnterTracking': '‚ö†Ô∏è Ë´ãËº∏ÂÖ•Âø´ÈÅûÂñÆËôüÔºÅ',
        'pleaseSelectRoute': '‚ö†Ô∏è Ë´ãÂÖàÈÅ∏ÊìáÈÅãÈÄÅÊñπÂºèÔºÅ',
        'confirmReset': 'Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊï¥ÂÄãÊµÅÁ®ãÂóéÔºüÈÄôÂ∞áÊ∏ÖÈô§ÊâÄÊúâÈÄ≤Â∫¶„ÄÇ',
        'completedAt': 'ÂÆåÊàêÊôÇÈñì',
        'notCompleted': 'Â∞öÊú™ÂÆåÊàê',
        'language': 'Ë™ûË®Ä'
    },
    'English': {
        'pageTitle': 'RTV Details',
        'btnBack': 'Back',
        'sectionBasic': 'Basic Info',
        'sectionTimeline': 'RTV Process',
        'progressText': 'Progress',
        'labelQPN': 'QPN',
        'labelSN': 'SN',
        'labelDept': 'Dept',
        'stage1Title': 'Kick Off',
        'stage1Desc': 'RTV process initiated',
        'stage2Title': 'Departed Factory',
        'stage2Desc': 'Material left factory',
        'stage3Title': 'Select Shipping Method',
        'stage3Desc': 'Choose Express or Return',
        'stage4aTitle': 'Enter Tracking Number',
        'stage4aDesc': 'Please enter tracking number',
        'stage5aTitle': 'Arrived at Vendor',
        'stage5aDesc': 'Material arrived (Express)',
        'stage4bTitle': 'Arrived at Vendor',
        'stage4bDesc': 'Material arrived (Return)',
        'stage6Title': 'FA in Progress',
        'stage6Desc': 'Failure analysis ongoing',
        'stage7Title': 'FA Completed',
        'stage7Desc': 'FA report completed',
        'labelTracking': 'Tracking #',
        'trackingDisplay': 'Tracking #',
        'routeExpressLabel': 'Express',
        'routeReturnLabel': 'Return',
        'btnComplete': 'Complete',
        'btnComplete4a': 'Confirm & Continue',
        'btnComplete7': 'Complete Process',
        'btnReset': 'Reset',
        'btnCancel': 'Cancel',
        'btnSave': 'Save',
        'btnPrint': 'Print',
        'statusReady': 'Ready.',
        'statusSaved': '‚úÖ Saved!',
        'statusCompleted': 'üéâ Completed!',
        'statusPending': 'Pending',
        'statusInProgress': 'In Progress',
        'statusDone': 'Done',
        'recordNotFound': '‚ùå Not found!',
        'pleaseEnterTracking': '‚ö†Ô∏è Enter tracking number!',
        'pleaseSelectRoute': '‚ö†Ô∏è Select shipping method!',
        'confirmReset': 'Reset process?',
        'completedAt': 'Completed at',
        'notCompleted': 'Not completed',
        'language': 'Language'
    },
    'Ti·∫øng Vi·ªát': {
        'pageTitle': 'Chi ti·∫øt RTV',
        'btnBack': 'Quay l·∫°i',
        'sectionBasic': 'Th√¥ng tin',
        'sectionTimeline': 'Quy tr√¨nh',
        'progressText': 'Ti·∫øn ƒë·ªô',
        'labelQPN': 'QPN',
        'labelSN': 'SN',
        'labelDept': 'B·ªô ph·∫≠n',
        'stage1Title': 'Kh·ªüi ƒë·ªông',
        'stage1Desc': 'B·∫Øt ƒë·∫ßu quy tr√¨nh',
        'stage2Title': 'ƒê√£ r·ªùi x∆∞·ªüng',
        'stage2Desc': 'V·∫≠t li·ªáu ƒë√£ r·ªùi x∆∞·ªüng',
        'stage3Title': 'Ch·ªçn v·∫≠n chuy·ªÉn',
        'stage3Desc': 'Ch·ªçn Express ho·∫∑c Return',
        'stage4aTitle': 'Nh·∫≠p s·ªë theo d√µi',
        'stage4aDesc': 'Nh·∫≠p s·ªë theo d√µi',
        'stage5aTitle': 'ƒê√£ ƒë·∫øn nh√† cung c·∫•p',
        'stage5aDesc': 'ƒê√£ ƒë·∫øn (Express)',
        'stage4bTitle': 'ƒê√£ ƒë·∫øn nh√† cung c·∫•p',
        'stage4bDesc': 'ƒê√£ ƒë·∫øn (Return)',
        'stage6Title': 'FA ƒëang ti·∫øn h√†nh',
        'stage6Desc': 'ƒêang ph√¢n t√≠ch',
        'stage7Title': 'FA ho√†n th√†nh',
        'stage7Desc': 'B√°o c√°o ho√†n th√†nh',
        'labelTracking': 'S·ªë theo d√µi',
        'trackingDisplay': 'S·ªë theo d√µi',
        'routeExpressLabel': 'Express',
        'routeReturnLabel': 'Return',
        'btnComplete': 'Ho√†n th√†nh',
        'btnComplete4a': 'X√°c nh·∫≠n',
        'btnComplete7': 'Ho√†n th√†nh',
        'btnReset': 'ƒê·∫∑t l·∫°i',
        'btnCancel': 'H·ªßy',
        'btnSave': 'L∆∞u',
        'btnPrint': 'In',
        'statusReady': 'S·∫µn s√†ng.',
        'statusSaved': '‚úÖ ƒê√£ l∆∞u!',
        'statusCompleted': 'üéâ Ho√†n th√†nh!',
        'statusPending': 'Ch·ªù',
        'statusInProgress': 'ƒêang',
        'statusDone': 'Xong',
        'recordNotFound': '‚ùå Kh√¥ng t√¨m th·∫•y!',
        'pleaseEnterTracking': '‚ö†Ô∏è Nh·∫≠p s·ªë!',
        'pleaseSelectRoute': '‚ö†Ô∏è Ch·ªçn v·∫≠n chuy·ªÉn!',
        'confirmReset': 'ƒê·∫∑t l·∫°i?',
        'completedAt': 'Ho√†n th√†nh l√∫c',
        'notCompleted': 'Ch∆∞a ho√†n th√†nh',
        'language': 'Ng√¥n ng·ªØ'
    }
};

let currentLang = 'ÁπÅÈ´î‰∏≠Êñá';
let currentRecord = null;
let recordId = null;
let currentStage = 0;
let selectedRoute = null;

const getEl = (id) => document.getElementById(id);

// Ê†ºÂºèÂåñÊó•ÊúüÊôÇÈñì
function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    recordId = urlParams.get('id');
    if (!recordId) {
        alert('ÈåØË™§ÔºöÊú™ÊåáÂÆöË®òÈåÑ IDÔºÅ');
        window.location.href = 'index.html';
        return;
    }
    loadRecord();
    setupEventListeners();
    applyLanguage();
    lucide.createIcons();
});

function loadRecord() {
    const storedRecords = localStorage.getItem('iqcRecords');
    if (!storedRecords) {
        updateStatus(langDict[currentLang].recordNotFound);
        setTimeout(() => window.location.href = 'index.html', 2000);
        return;
    }
    const records = JSON.parse(storedRecords);
    currentRecord = records.find(r => r.id === parseInt(recordId));
    if (!currentRecord) {
        updateStatus(langDict[currentLang].recordNotFound);
        setTimeout(() => window.location.href = 'index.html', 2000);
        return;
    }
    if (!currentRecord.rtv_data) {
        currentRecord.rtv_data = {
            current_stage: 0,
            selected_route: null,
            tracking_number: '',
            stage_completion: {},
            completion_dates: {}
        };
    }
    currentStage = currentRecord.rtv_data.current_stage || 0;
    selectedRoute = currentRecord.rtv_data.selected_route || null;
    displayRecordInfo();
    loadRTVData();
    updateAllStages();
}

function displayRecordInfo() {
    getEl('display-qpn').textContent = currentRecord.qpn || '-';
    getEl('display-sn').textContent = currentRecord.sn || '-';
    getEl('display-dept').textContent = currentRecord.dept || '-';
}

function loadRTVData() {
    const data = currentRecord.rtv_data || {};
    if (data.tracking_number) {
        getEl('tracking-number').value = data.tracking_number;
        getEl('tracking-value').textContent = data.tracking_number;
    }
    if (data.selected_route) {
        selectedRoute = data.selected_route;
        highlightSelectedRoute();
    }
}

function saveRTVData() {
    const data = currentRecord.rtv_data;
    data.tracking_number = getEl('tracking-number').value;
    data.selected_route = selectedRoute;
    const storedRecords = localStorage.getItem('iqcRecords');
    const records = JSON.parse(storedRecords);
    const index = records.findIndex(r => r.id === parseInt(recordId));
    if (index > -1) {
        records[index] = currentRecord;
        localStorage.setItem('iqcRecords', JSON.stringify(records));
        updateStatus(langDict[currentLang].statusSaved);
    }
}

function selectRoute(route) {
    if (currentStage >= 3) return;
    
    selectedRoute = route;
    currentRecord.rtv_data.selected_route = route;
    highlightSelectedRoute();
    
    setTimeout(() => {
        completeStage(3);
    }, 500);
}

function highlightSelectedRoute() {
    const expressBtn = getEl('route-express');
    const returnBtn = getEl('route-return');
    
    expressBtn.classList.remove('selected');
    returnBtn.classList.remove('selected');
    
    if (selectedRoute === 'express') {
        expressBtn.classList.add('selected');
    } else if (selectedRoute === 'return') {
        returnBtn.classList.add('selected');
    }
}

function completeStage(stage) {
    const lang = langDict[currentLang];
    
    if (stage === 3) {
        if (!selectedRoute) {
            alert(lang.pleaseSelectRoute);
            return;
        }
    }
    
    if (stage === '4a') {
        const trackingNumber = getEl('tracking-number').value.trim();
        if (!trackingNumber) {
            alert(lang.pleaseEnterTracking);
            getEl('tracking-number').focus();
            return;
        }
        getEl('tracking-value').textContent = trackingNumber;
    }
    
    // Ë®òÈåÑÂÆåÊàêÊôÇÈñì
    const now = new Date().toISOString();
    const stageKey = 'stage' + stage;
    currentRecord.rtv_data.stage_completion[stageKey] = true;
    currentRecord.rtv_data.completion_dates[stageKey] = now;
    
    // Êõ¥Êñ∞Áï∂ÂâçÈöéÊÆµ
    if (stage === 1) currentStage = 1;
    else if (stage === 2) currentStage = 2;
    else if (stage === 3) currentStage = 3;
    else if (stage === '4a') currentStage = 4;
    else if (stage === '5a') currentStage = 5;
    else if (stage === '4b') currentStage = 4;
    else if (stage === 6) currentStage = 6;
    else if (stage === 7) currentStage = 7;
    
    currentRecord.rtv_data.current_stage = currentStage;
    
    saveRTVData();
    updateAllStages();
    
    if (stage === 7) {
        updateStatus(lang.statusCompleted);
        confetti();
    }
}

function resetProcess() {
    const lang = langDict[currentLang];
    if (!confirm(lang.confirmReset)) return;
    
    currentRecord.rtv_data = {
        current_stage: 0,
        selected_route: null,
        tracking_number: '',
        stage_completion: {},
        completion_dates: {}
    };
    currentStage = 0;
    selectedRoute = null;
    getEl('tracking-number').value = '';
    saveRTVData();
    updateAllStages();
    updateStatus(lang.statusReady);
}

function updateAllStages() {
    const completion = currentRecord.rtv_data.stage_completion;
    const completionDates = currentRecord.rtv_data.completion_dates;
    const lang = langDict[currentLang];
    
    let totalStages = 7;
    if (selectedRoute === 'express') totalStages = 7;
    else if (selectedRoute === 'return') totalStages = 6;
    else totalStages = 3;
    
    const completedCount = Object.values(completion).filter(v => v).length;
    const progressPercentage = totalStages > 0 ? Math.round((completedCount / totalStages) * 100) : 0;
    getEl('progress-percentage').textContent = progressPercentage + '%';
    
    document.querySelectorAll('.timeline-item[data-route]').forEach(item => {
        item.classList.add('hidden-stage');
    });
    
    if (selectedRoute === 'express') {
        getEl('stage-4a').classList.remove('hidden-stage');
        getEl('stage-5a').classList.remove('hidden-stage');
        getEl('stage-6').classList.remove('hidden-stage');
        getEl('stage-7').classList.remove('hidden-stage');
    } else if (selectedRoute === 'return') {
        getEl('stage-4b').classList.remove('hidden-stage');
        getEl('stage-6').classList.remove('hidden-stage');
        getEl('stage-7').classList.remove('hidden-stage');
    }
    
    updateStageStatus('stage-1', 1, completion, completionDates, lang);
    updateStageStatus('stage-2', 2, completion, completionDates, lang);
    updateStageStatus('stage-3', 3, completion, completionDates, lang);
    
    if (selectedRoute === 'express') {
        updateStageStatus('stage-4a', 4, completion, completionDates, lang);
        updateStageStatus('stage-5a', 5, completion, completionDates, lang);
        updateStageStatus('stage-6', 6, completion, completionDates, lang);
        updateStageStatus('stage-7', 7, completion, completionDates, lang);
    } else if (selectedRoute === 'return') {
        updateStageStatus('stage-4b', 4, completion, completionDates, lang);
        updateStageStatus('stage-6', 6, completion, completionDates, lang);
        updateStageStatus('stage-7', 7, completion, completionDates, lang);
    }
    
    if (currentStage >= 3) {
        document.querySelectorAll('.route-option').forEach(opt => {
            opt.style.pointerEvents = 'none';
            opt.style.opacity = '0.6';
        });
    }
}

function updateStageStatus(stageId, stageNum, completion, completionDates, lang) {
    const stageEl = getEl(stageId);
    if (!stageEl) return;
    
    const badgeEl = getEl(stageId + '-badge');
    const stageKey = 'stage' + (stageId.includes('a') || stageId.includes('b') ? stageId.split('-')[1] : stageNum);
    
    stageEl.classList.remove('pending', 'active', 'completed');
    
    // ÁßªÈô§ËàäÁöÑÊôÇÈñìÈ°ØÁ§∫
    const existingTimeDisplay = stageEl.querySelector('.completion-time');
    if (existingTimeDisplay) {
        existingTimeDisplay.remove();
    }
    
    if (completion[stageKey]) {
        stageEl.classList.add('completed');
        badgeEl.textContent = lang.statusDone;
        badgeEl.className = 'px-3 py-1 text-xs font-semibold rounded-full bg-blue-200 text-blue-700';
        
        // Ê∑ªÂä†ÂÆåÊàêÊôÇÈñìÈ°ØÁ§∫
        const completionTime = completionDates[stageKey];
        if (completionTime) {
            const timeDisplay = document.createElement('div');
            timeDisplay.className = 'completion-time mt-3 p-2 bg-blue-50 rounded-lg border border-blue-200';
            timeDisplay.innerHTML = `
                <div class="flex items-center text-xs text-blue-800">
                    <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                    <span class="font-medium">${lang.completedAt}:</span>
                    <span class="ml-2 font-mono">${formatDateTime(completionTime)}</span>
                </div>
            `;
            const contentDiv = stageEl.querySelector('.timeline-content');
            if (contentDiv) {
                contentDiv.appendChild(timeDisplay);
                lucide.createIcons();
            }
        }
    } else if (currentStage === stageNum - 1 || (stageNum === 3 && currentStage === 2)) {
        stageEl.classList.add('active');
        badgeEl.textContent = lang.statusInProgress;
        badgeEl.className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-200 text-green-700';
    } else {
        stageEl.classList.add('pending');
        badgeEl.textContent = lang.statusPending;
        badgeEl.className = 'px-3 py-1 text-xs font-semibold rounded-full bg-gray-200 text-gray-700';
    }
}

function setupEventListeners() {
    getEl('lang-selector').addEventListener('change', (e) => {
        currentLang = e.target.value;
        applyLanguage();
    });
    getEl('save-btn').addEventListener('click', saveRTVData);
    getEl('reset-btn').addEventListener('click', resetProcess);
    getEl('print-btn').addEventListener('click', () => window.print());
    
    const trackingField = getEl('tracking-number');
    if (trackingField) trackingField.addEventListener('blur', () => saveRTVData());
}

function applyLanguage() {
    const lang = langDict[currentLang];
    getEl('page-title').textContent = lang.pageTitle;
    getEl('btn-back').textContent = lang.btnBack;
    getEl('section-basic').textContent = lang.sectionBasic;
    getEl('section-timeline').textContent = lang.sectionTimeline;
    getEl('progress-text').innerHTML = lang.progressText + 'Ôºö<span id="progress-percentage" class="font-bold text-indigo-600">' + getEl('progress-percentage').textContent + '</span>';
    
    const stages = ['1', '2', '3', '4a', '5a', '4b', '6', '7'];
    stages.forEach(s => {
        const titleEl = getEl('stage-' + s + '-title');
        const descEl = getEl('stage-' + s + '-desc');
        if (titleEl) titleEl.textContent = lang['stage' + s + 'Title'];
        if (descEl) descEl.textContent = lang['stage' + s + 'Desc'];
    });
    
    getEl('route-express-label').textContent = lang.routeExpressLabel;
    getEl('route-return-label').textContent = lang.routeReturnLabel;
    getEl('label-tracking').textContent = lang.labelTracking;
    
    updateAllStages();
    lucide.createIcons();
}

function updateStatus(message, clearAfterMs = 3000) {
    const statusBar = getEl('status-bar');
    statusBar.textContent = message;
    if (window.statusTimeout) clearTimeout(window.statusTimeout);
    if (clearAfterMs > 0) {
        window.statusTimeout = setTimeout(() => {
            statusBar.textContent = langDict[currentLang].statusReady;
        }, clearAfterMs);
    }
}

function confetti() {
    const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe'];
    const confettiCount = 50;
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'fixed';
        confetti.style.width = '10px';
        confetti.style.height = '10px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * window.innerWidth + 'px';
        confetti.style.top = '-10px';
        confetti.style.opacity = '1';
        confetti.style.borderRadius = '50%';
        confetti.style.zIndex = '9999';
        confetti.style.pointerEvents = 'none';
        document.body.appendChild(confetti);
        const fallDuration = 2000 + Math.random() * 1000;
        const horizontalMovement = (Math.random() - 0.5) * 200;
        confetti.animate([
            { transform: 'translate(0, 0) rotate(0deg)', opacity: 1 },
            { transform: 'translate(' + horizontalMovement + 'px, ' + (window.innerHeight + 10) + 'px) rotate(' + (Math.random() * 720) + 'deg)', opacity: 0 }
        ], {
            duration: fallDuration,
            easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
        }).onfinish = () => confetti.remove();
    }
}

window.completeStage = completeStage;
window.selectRoute = selectRoute;
window.resetProcess = resetProcess;
